 worker_processes auto;
 pid /tmp/nginx.pid;

 # Definicja plików logów dla środowiska Azure App Service
 error_log /home/LogFiles/nginx/error.log warn;

 events {
     worker_connections 1024;
 }

 http {
     include       mime.types;
     default_type  application/octet-stream;

     # Definicja formatu i lokalizacji logów
     log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
     access_log /home/LogFiles/nginx/access.log main;

     # Ustawienia wydajności i bezpieczeństwa
     sendfile        on;
     keepalive_timeout 65;
     server_tokens   off;

     server {
         listen 8080;
         server_name _;

         root /home/site/wwwroot/public;

         # Priorytet dla pliku index frontendu. Backend jest obsługiwany przez routing.
         index index.html index.htm;

         # Bezpieczeństwo: Blokuj dostęp do ukrytych plików, np. .htaccess
         location ~ /\.ht {
             deny all;
         }

         # Przekieruj wszystkie wywołania API do front-controllera backendu (index.php).
         # Framework Slim zajmie się dalszym routingiem konkretnego endpointu API.
         location /api {
             try_files $uri /index.php$is_args$args;
         }

         # Obsłuż wszystkie inne żądania jako część aplikacji frontendowej (SPA).
         # Jeśli plik/katalog nie istnieje, zwróć index.html, aby routing po stronie klienta mógł zadziałać.
         location / {
             try_files $uri $uri/ /index.html;
         }

         # Przetwarzaj pliki PHP. Ta sekcja obsłuży żądania przepisane z bloku /api.
         location ~ \.php$ {
             try_files $uri =404;
             fastcgi_split_path_info ^(.+\.php)(/.+)$;
             fastcgi_pass 127.0.0.1:9000; # Zakładając, że PHP-FPM nasłuchuje na porcie 9000
             fastcgi_index index.php;
             include fastcgi_params;
             fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
             fastcgi_param PATH_INFO $fastcgi_path_info;
         }
     }
 }
